version: 2.1

orbs:
  win: circleci/windows@2.4.0

commands:
  update-yarn:
    steps:
      - run:
          name: Update yarn
          command: yarn global add yarn@latest
  install:
    steps:
      - run:
          name: Install dependencies
          command: yarn install --ignore-engines --frozen-lockfile --cache-folder ~/.cache/yarn
  install-win:
    steps:
      - run:
          name: Install windows dependencies
          command: yarn install --ignore-engines --frozen-lockfile --cache-folder %systemdrive%%homepath%/.cache/yarn
  audit:
    steps:
      - run:
          name: Audit dependencies
          command: yarn audit
  build:
    steps:
      - run:
          name: Build packages
          command: yarn build
  lint:
    steps:
      - run:
          name: Lint project
          command: yarn lint
  format:
    steps:
      - run:
          name: Format project
          command: yarn format
  deps:
    steps:
      - run:
          name: Check dependencies
          command: yarn deps
  test:
    steps:
      - run:
          name: Test
          command: yarn test-ci
  save-cache:
    steps:
      - save_cache:
          key: v2.2-{{ arch }}-yarn-lock-{{ .Environment.CIRCLE_JOB }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
  restore-cache:
    steps:
      - restore_cache:
          keys:
            - v2.2-{{ arch }}-yarn-lock-{{ .Environment.CIRCLE_JOB }}-{{ checksum "yarn.lock" }}
  run-all:
    steps:
      - checkout
      - update-yarn
      - restore-cache
      - install
      - save-cache
      - build
      - lint
      - format
      - deps
      - test
  run-tests:
    parameters:
      win:
        type: boolean
        default: false
    steps:
      - checkout
      - update-yarn
      - restore-cache
      - when:
          condition: << parameters.win >>
          steps:
            - install-win
      - unless:
          condition: << parameters.win >>
          steps:
            - install
      - save-cache
      - build
      - test
jobs:
  v10:
    docker:
      - image: node:10
    steps:
      - run-tests
  v12:
    docker:
      - image: node:12
    steps:
      - run-all
  v14:
    docker:
      - image: node:14
    steps:
      - run-tests
  windows-v12:
    executor: win/default
    steps:
      - run-tests:
          win: true

workflows:
  node:
    jobs:
      - v10
      - v12
      - v14
      - windows-v12
